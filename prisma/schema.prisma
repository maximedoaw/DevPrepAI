// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// schema.prisma - Version optimisée

enum SubscriptionTier {
  FREE
  PREMIUM
  EXPERT
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  MISSION
  CDI
  STAGE
}

enum WorkMode {
  REMOTE
  ON_SITE
  HYBRID 
}

enum Role {
  ENTERPRISE
  BOOTCAMP
  SCHOOL
  CANDIDATE
  RECRUITER
  CAREER_CHANGER
}

enum Domain {
  MACHINE_LEARNING
  DEVELOPMENT
  DATA_SCIENCE
  FINANCE
  BUSINESS
  ENGINEERING
  DESIGN
  DEVOPS
  CYBERSECURITY
  MARKETING
  PRODUCT
  ARCHITECTURE
  MOBILE
  WEB
  COMMUNICATION
  MANAGEMENT
  EDUCATION
  HEALTH
}

enum PortfolioTemplate {
  CLASSIC
  MODERN
  CORPORATE
  MINIMAL
  THREE_D
}

enum Difficulty {
  JUNIOR
  MID
  SENIOR
}

enum QuizType {
  QCM 
  MOCK_INTERVIEW
  SOFT_SKILLS
  TECHNICAL
}

enum InterviewRoomType {
  TECH
  HR
  EXECUTIVE
}

model User {
  id                 String         @id @default(cuid())
  email              String         @unique
  kindeId            String?        @unique
  firstName          String?
  lastName           String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  credits            Int            @default(5000)
  matchingJobs       Int            @default(0)
  skills             String[]      
  role               Role           @default(CANDIDATE)
  domains            Domain[]       // Domaines sélectionnés
  subscription       Subscription?
  quizResults        QuizResult[]
  skillAnalyses      SkillAnalysis[]
  progressTracking   ProgressTracking[]
  chatSessions       ChatSession[]
  interviewRooms     InterviewRoom[]
  voiceInterviews    VoiceInterview[]
  recommendations    Recommendation[]
  applications       Application[]
  portfolio          Portfolio[]

  @@index([createdAt])
  @@index([role])
  @@map("users")
}

model Portfolio {
  id             String      @id @default(cuid())
  userId         String
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String      @default("Mon Portfolio")
  bio            String?
  headline       String?     // phrase d'accroche IA
  template       PortfolioTemplate @default(CLASSIC)
  themeColor     String?     // ex: "blue", "slate", "amber"
  avatarUrl      String?
  bannerUrl      String?
  projects       Json?       // liste de projets (nom, description, lien, image)
  experiences    Json?       // expériences pro
  education      Json?       // formations
  certifications Json?       // badges IA, certificats, etc.
  skills         String[]    // liste de compétences clés
  languages      String[]    // langues parlées
  socialLinks    Json?       // github, linkedin, dribbble, etc.
  achievements   Json?       // prix, distinctions
  visibility     Boolean     @default(true)
  publishedAt    DateTime?
  updatedAt      DateTime    @updatedAt
  createdAt      DateTime    @default(now())

  @@index([userId])
  @@map("portfolios")
}


model JobPosting {
  id          String   @id @default(cuid())
  companyName   String
  title       String
  description String
  location    String?
  domains     Domain[] 
  skills      String[] 
  salaryMin   Float?
  salaryMax   Float?
  currency    String   @default("FCFA")
  type        JobType
  workMode    WorkMode
  experienceLevel Difficulty?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isActive    Boolean  @default(true)
  metadata    Json?
  applications Application[]
  @@map("job_postings")
}

model Application {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  jobId       String
  job         JobPosting @relation(fields: [jobId], references: [id])
  coverLetter String?
  portfolioUrl String?
  resumeUrl   String?
  status      String   // "applied","prescreen","interview","rejected","hired"
  score       Int?     // aggregated score from pre-screens
  reportUrl   String?  // PDF report
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@map("applications")
}

model Subscription {
  id               String           @id @default(cuid())
  userId           String           @unique
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier             SubscriptionTier @default(FREE)
  startDate        DateTime         @default(now())
  endDate          DateTime?
  isActive         Boolean          @default(true)
  stripeCustomerId String?
  stripeSubscriptionId String?
  features         Json?

  @@index([isActive])
  @@index([endDate])
  @@map("subscriptions")
}

model Quiz {
  id          String     @id @default(cuid())
  title       String
  description String?
  image       String?
  type        QuizType
  domain      Domain
  questions   Json
  difficulty  Difficulty @default(JUNIOR)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  company     String
  technology  String[]
  results     QuizResult[]
  duration    Int
  totalPoints Int

  @@index([type])
  @@index([difficulty])
  @@map("quizzes")
}

model QuizResult {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId      String
  quiz        Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  skillAnalysis SkillAnalysis[]
  score       Float
  answers     Json
  analysis    String
  duration    Int?
  completedAt DateTime   @default(now())

  @@index([userId, completedAt])
  @@index([quizId])
  @@index([score])
  @@index([completedAt])
  @@map("quiz_results")
}

model SkillAnalysis {
  id              String     @id @default(cuid())
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizResultId    String?
  quizResult      QuizResult? @relation(fields: [quizResultId], references: [id], onDelete: Cascade)
  skills          Json
  aiFeedback      String?
  improvementTips String[]
  analyzedAt      DateTime   @default(now())

  @@index([userId, analyzedAt])
  @@index([quizResultId])
  @@map("skill_analyses")
}

model ProgressTracking {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  metric      String
  value       Float
  date        DateTime   @default(now())
  context     Json?

  @@index([userId, metric, date])
  @@index([date])
  @@map("progress_tracking")
}

model Recommendation {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  source       String
  content      String
  vector       Json?
  relatedItems Json?
  weight       Float      @default(1.0)
  viewed       Boolean    @default(false)
  createdAt    DateTime   @default(now())

  @@index([userId, viewed])
  @@index([createdAt])
  @@map("recommendations")
}

model ChatSession {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages     Json
  sessionType  String
  startedAt    DateTime   @default(now())
  lastActivity DateTime   @updatedAt
  feedback     Json?

  @@index([userId, lastActivity])
  @@map("chat_sessions")
}

model InterviewRoom {
  id           String           @id @default(cuid())
  userId       String
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  roomType     InterviewRoomType
  roomData     Json
  participants Json?
  startedAt    DateTime         @default(now())
  endedAt      DateTime?
  recordingUrl String?

  @@index([userId, startedAt])
  @@map("interview_rooms")
}

model VoiceInterview {
  id              String     @id @default(cuid())
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  technologies    String[]
  context         String
  duration        Int
  conversationId  String?
  transcription   Json?
  actualDuration  Int?
  status          String     @default("pending")
  startedAt       DateTime   @default(now())
  endedAt         DateTime?
  feedback        Json?
  score           Float?

  @@index([userId, startedAt])
  @@index([status])
  @@map("voice_interviews")
}

