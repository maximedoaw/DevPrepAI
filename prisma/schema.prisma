// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  PREMIUM
  EXPERT
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  MISSION
  CDI
  STAGE
}

enum WorkMode {
  REMOTE
  ON_SITE
  HYBRID 
}

enum Role {
  ENTERPRISE
  BOOTCAMP
  SCHOOL
  CANDIDATE
  RECRUITER
  CAREER_CHANGER
}

enum Domain {
  MACHINE_LEARNING
  DEVELOPMENT
  DATA_SCIENCE
  FINANCE
  BUSINESS
  ENGINEERING
  DESIGN
  DEVOPS
  CYBERSECURITY
  MARKETING
  PRODUCT 
  ARCHITECTURE
  MOBILE
  WEB
  COMMUNICATION
  MANAGEMENT
  EDUCATION
  HEALTH
}

enum PortfolioTemplate {
  CLASSIC
  MODERN
  CORPORATE
  TECH
  MINIMAL
  THREE_D
}

enum Difficulty {
  JUNIOR
  MID
  SENIOR
}

enum QuizType {
  QCM 
  MOCK_INTERVIEW
  SOFT_SKILLS
  TECHNICAL
}

enum InterviewRoomType {
  TECH
  HR
  EXECUTIVE
}

enum CourseContentType {
  TEXT
  VIDEO
  PDF
}

enum BootcampEnrollmentStatus {
  ACTIVE
  AT_RISK
  INACTIVE
}

enum BootcampNotificationType {
  ASSIGNMENT
  FEEDBACK
  REMINDER
  ACHIEVEMENT
}

enum BootcampInvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
}


model User {
  id               String              @id @default(cuid())
  email            String              @unique
  kindeId          String?             @unique
  firstName        String?
  lastName         String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  credits          Int                 @default(5000)
  matchingJobs     Int                 @default(0)
  imageUrl         String?        
  skills           String[]
  role             Role                @default(CANDIDATE)
  domains          Domain[]

  
  // Relations
  subscription     Subscription?
  quizResults      QuizResult[]
  skillAnalyses    SkillAnalysis[]
  progressTracking ProgressTracking[]
  chatSessions     ChatSession[]
  interviewRooms   InterviewRoom[]
  voiceInterviews  VoiceInterview[]
  recommendations  Recommendation[]
  applications     Application[]       @relation("UserApplications")
  portfolio        Portfolio[]
  jobPostings      JobPosting[]        @relation("UserJobPostings")
  JobQuizResults   JobQuizResult[]
  organizedMeetings InterviewMeeting[] @relation("UserOrganizedMeetings")
  candidateMeetings InterviewMeeting[] @relation("UserCandidateMeetings")
  candidateMatchings CandidateMatching[] @relation("CandidateMatchings")
  bootcampEnrollments BootcampEnrollment[]
  bootcampFeedbacksGiven BootcampFeedback[] @relation("BootcampFeedbackInstructor")
  bootcampFeedbacksReceived BootcampFeedback[] @relation("BootcampFeedbackStudent")
  bootcampNotifications BootcampNotification[]
  bootcampCourseViews BootcampCourseView[]
  bootcampCoursesCreated BootcampCourse[] @relation("BootcampCourseCreator")
  bootcampInvitationsSent BootcampInvitation[] @relation("BootcampInvitationSender")
  bootcampInvitationsReceived BootcampInvitation[] @relation("BootcampInvitationReceiver")

  @@index([createdAt])
  @@index([role])
  @@map("users")
}

model Portfolio {
  id               String              @id @default(cuid())
  userId           String
  title            String              @default("Mon Portfolio")
  bio              String?
  headline         String?
  template         PortfolioTemplate   @default(CLASSIC)
  themeColor       String?
  avatarUrl        String?
  bannerUrl        String?
  projects         Json?
  experiences      Json?
  education        Json?
  certifications   Json?
  skills           String[]
  languages        String[]
  interests        String[]
  sections         String[]
  socialLinks      Json?
  achievements     Json?
  publishedAt      DateTime?
  updatedAt        DateTime            @updatedAt
  createdAt        DateTime            @default(now())
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("portfolios")
}

model JobPosting {
  id               String              @id @default(cuid())
  companyName      String
  userId           String
  title            String
  description      String
  location         String?
  domains          Domain[]
  skills           String[]
  salaryMin        Float?
  salaryMax        Float?
  currency         String              @default("FCFA")
  type             JobType
  workMode         WorkMode
  experienceLevel  Difficulty?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  isActive         Boolean             @default(true)
  metadata         Json?
  
  // Relations
  user             User                @relation("UserJobPostings", fields: [userId], references: [id], onDelete: Cascade)
  applications     Application[]       @relation("JobApplications")
  jobQuizzes       JobQuiz[]
  interviewMeetings InterviewMeeting[]
  candidateMatchings CandidateMatching[]

  @@map("job_postings")
} 

model Application {
  id               String              @id @default(cuid())
  userId           String
  jobId            String
  coverLetter      String?
  portfolioUrl     String?
  resumeUrl        String?
  status           String              @default("PENDING")
  score            Int?
  reportUrl        String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  
  // Relations
  user             User                @relation("UserApplications", fields: [userId], references: [id], onDelete: Cascade)
  job              JobPosting          @relation("JobApplications", fields: [jobId], references: [id], onDelete: Cascade)
  interviewMeetings InterviewMeeting[]

  @@map("applications")
}

model CandidateMatching {
  id               String              @id @default(cuid())
  jobPostingId     String
  candidateId      String
  matchScore       Float               // Score de matching (0-100)
  aiReason         String?             // Raison du matching générée par l'IA
  skillsMatch      Float               // Pourcentage de correspondance des compétences
  domainMatch      Float               // Pourcentage de correspondance des domaines
  experienceMatch  Float?              // Pourcentage de correspondance de l'expérience
  status           String              @default("PENDING") // PENDING, VIEWED, CONTACTED, REJECTED
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  
  // Relations
  jobPosting       JobPosting          @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  candidate        User                @relation("CandidateMatchings", fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([jobPostingId, candidateId])
  @@index([jobPostingId])
  @@index([candidateId])
  @@index([matchScore])
  @@index([status])
  @@map("candidate_matchings")
}

model Subscription {
  id                   String            @id @default(cuid())
  userId               String            @unique
  tier                 SubscriptionTier  @default(FREE)
  startDate            DateTime          @default(now())
  endDate              DateTime?
  isActive             Boolean           @default(true)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  features             Json?
  
  // Relations
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([endDate])
  @@map("subscriptions")
}

model Quiz {
  id               String              @id @default(cuid())
  title            String
  description      String?
  image            String?
  type             QuizType
  domain           Domain
  questions        Json
  difficulty       Difficulty          @default(JUNIOR)
  duration         Int
  totalPoints      Int
  company          String
  technology       String[]
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  
  // Relations
  results          QuizResult[]

  @@index([type])
  @@index([difficulty])
  @@map("quizzes")
}

// JobQuiz contient maintenant tous les détails du quiz + la relation au job
model JobQuiz {
  id               String              @id @default(cuid())
  
  // Champs du quiz (mêmes que le modèle Quiz)
  title            String
  description      String?
  image            String?
  type             QuizType
  domain           Domain
  questions        Json
  difficulty       Difficulty          @default(JUNIOR)
  duration         Int
  totalPoints      Int
  company          String
  technology       String[]
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  settings         Json?
  
  // Relations
  jobPostingId     String
  jobPosting       JobPosting          @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  results          JobQuizResult[]

  @@index([type])
  @@index([difficulty])
  @@index([jobPostingId])
  @@map("job_quizzes")
} 

// Résultats spécifiques aux JobQuiz
model JobQuizResult {
  id               String              @id @default(cuid())
  userId           String
  jobQuizId        String
  score            Float
  answers          Json
  analysis         String?
  reviewScore      Float?
  finalScore       Float?
  feedbackVisibleToCandidate Boolean      @default(false)
  feedbackReleasedAt      DateTime?
  duration         Int?
  completedAt      DateTime            @default(now())
  videoUrl         String?             // URL de la vidéo soumise pour les tests techniques
  imageUrls        Json?                // Tableau JSON des URLs d'images soumises pour les tests techniques
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobQuiz          JobQuiz             @relation(fields: [jobQuizId], references: [id], onDelete: Cascade)
  skillAnalysis    SkillAnalysis[]

  @@index([userId, completedAt])
  @@index([jobQuizId])
  @@index([score])
  @@index([completedAt])
  @@map("job_quiz_results")
}

enum InterviewMeetingStatus {
  PLANNED
  CONFIRMED
  COMPLETED
  CANCELLED
}

model InterviewMeeting {
  id               String                    @id @default(cuid())
  organizerId      String
  jobPostingId     String
  applicationId    String?
  candidateId      String
  scheduledAt      DateTime
  durationMinutes  Int?                      @default(30)
  location         String?
  meetingLink      String?
  notes            String?
  status           InterviewMeetingStatus    @default(PLANNED)
  reminderSent     Boolean                   @default(false)
  candidateNotes   String?
  candidateRespondedAt DateTime?
  isPublished      Boolean                   @default(false)
  publishedAt      DateTime?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  organizer        User                      @relation("UserOrganizedMeetings", fields: [organizerId], references: [id], onDelete: Cascade)
  job              JobPosting                @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  application      Application?              @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  candidate        User                      @relation("UserCandidateMeetings", fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([organizerId])
  @@index([candidateId])
  @@index([jobPostingId, scheduledAt])
  @@index([status])
  @@map("interview_meetings")
}

model QuizResult {
  id               String              @id @default(cuid())
  userId           String
  quizId           String
  score            Float
  answers          Json
  analysis         String
  duration         Int?
  completedAt      DateTime            @default(now())
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz             Quiz                @relation(fields: [quizId], references: [id], onDelete: Cascade)
  skillAnalysis    SkillAnalysis[]

  @@index([userId, completedAt])
  @@index([quizId])
  @@index([score])
  @@index([completedAt])
  @@map("quiz_results")
}

model SkillAnalysis {
  id               String              @id @default(cuid())
  userId           String
  quizResultId     String?
  jobQuizResultId  String?
  skills           Json
  aiFeedback       String?
  improvementTips  String[]
  analyzedAt       DateTime            @default(now())
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizResult       QuizResult?         @relation(fields: [quizResultId], references: [id], onDelete: Cascade)
  jobQuizResult    JobQuizResult?      @relation(fields: [jobQuizResultId], references: [id], onDelete: Cascade)

  @@index([userId, analyzedAt])
  @@index([quizResultId])
  @@index([jobQuizResultId])
  @@map("skill_analyses")
}

model ProgressTracking {
  id               String              @id @default(cuid())
  userId           String
  metric           String
  value            Float
  date             DateTime            @default(now())
  context          Json?
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, metric, date])
  @@index([date])
  @@map("progress_tracking")
}

model Recommendation {
  id               String              @id @default(cuid())
  userId           String
  source           String
  content          String
  vector           Json?
  relatedItems     Json?
  weight           Float               @default(1.0)
  viewed           Boolean             @default(false)
  createdAt        DateTime            @default(now())
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, viewed])
  @@index([createdAt])
  @@map("recommendations")
}

model ChatSession {
  id               String              @id @default(cuid())
  userId           String
  messages         Json
  sessionType      String
  startedAt        DateTime            @default(now())
  lastActivity     DateTime            @updatedAt
  feedback         Json?
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, lastActivity])
  @@map("chat_sessions")
}

model InterviewRoom {
  id               String              @id @default(cuid())
  userId           String
  roomType         InterviewRoomType
  roomData         Json
  participants     Json?
  startedAt        DateTime            @default(now())
  endedAt          DateTime?
  recordingUrl     String?
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startedAt])
  @@map("interview_rooms")
}

model VoiceInterview {
  id               String              @id @default(cuid())
  userId           String
  technologies     String[]
  context          String
  duration         Int
  conversationId   String?
  transcription    Json?
  actualDuration   Int?
  status           String              @default("pending")
  startedAt        DateTime            @default(now())
  endedAt          DateTime?
  feedback         Json?
  score            Float?
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startedAt])
  @@index([status])
  @@map("voice_interviews")
}

// Modèles pour le système de bootcamp
model BootcampCourse {
  id               String              @id @default(cuid())
  title            String
  description      String?
  domain           Domain
  order            Int                  @default(0)
  duration         Int?                 // Durée en minutes
  isPublished      Boolean              @default(false)
  createdById      String?              // ID de l'utilisateur qui a créé le cours (optionnel temporairement pour migration)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  courseImage      String?              // URL de l'image du cours (uploadthing)
  courseSections   Json?
  // Relations
  createdBy        User?               @relation("BootcampCourseCreator", fields: [createdById], references: [id], onDelete: Cascade)
  courseViews      BootcampCourseView[]

  @@index([domain])
  @@index([isPublished])
  @@index([createdById])
  @@map("bootcamp_courses")
}

model BootcampCourseView {
  id               String              @id @default(cuid())
  userId           String
  courseId         String
  viewedAt         DateTime            @default(now())
  progress         Float               @default(0) // 0-100
  completedAt      DateTime?
  completedLessons String[]            @default([]) // IDs des leçons complétées
  
  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  course           BootcampCourse      @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("bootcamp_course_views")
}

model BootcampEnrollment {
  id               String                      @id @default(cuid())
  userId           String
  bootcampDomains  Domain[]                    // Domaines couverts par le bootcamp
  status           BootcampEnrollmentStatus    @default(ACTIVE)
  progress         Float                       @default(0) // 0-100
  badges           String[]                    // Liste des badges obtenus
  isJobReady       Boolean                     @default(false)
  enrolledAt       DateTime                    @default(now())
  updatedAt        DateTime                    @updatedAt
  
  // Relations
  user             User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedbacks       BootcampFeedback[]
  assignedTests   BootcampAssignedTest[]

  @@unique([userId])
  @@index([status])
  @@index([userId])
  @@map("bootcamp_enrollments")
}

model BootcampFeedback {
  id               String              @id @default(cuid())
  enrollmentId     String
  instructorId     String              // ID du formateur (User avec role BOOTCAMP)
  studentId        String              // ID de l'apprenant
  content          String
  rating           Int?                // 1-5
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  
  // Relations
  enrollment      BootcampEnrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  instructor      User                @relation("BootcampFeedbackInstructor", fields: [instructorId], references: [id], onDelete: Cascade)
  student         User                @relation("BootcampFeedbackStudent", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([studentId])
  @@index([instructorId])
  @@map("bootcamp_feedbacks")
}

model BootcampAssignedTest {
  id               String              @id @default(cuid())
  enrollmentId     String
  quizId           String?             // Quiz existant
  jobQuizId        String?             // JobQuiz existant
  assignedBy      String              // ID du formateur
  assignedTo       String              // ID de l'apprenant
  dueDate          DateTime?
  completedAt      DateTime?
  status           String              @default("PENDING") // PENDING, COMPLETED, OVERDUE
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  
  // Relations
  enrollment       BootcampEnrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([assignedTo])
  @@index([status])
  @@map("bootcamp_assigned_tests")
}

model BootcampNotification {
  id               String                      @id @default(cuid())
  userId           String
  type             BootcampNotificationType
  title            String
  message          String
  isRead           Boolean                     @default(false)
  metadata         Json?                       // Données supplémentaires (ID de test, feedback, etc.)
  createdAt        DateTime                    @default(now())
  
  // Relations
  user             User                        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("bootcamp_notifications")
}

model BootcampInvitation {
  id               String                      @id @default(cuid())
  bootcampId       String                      // ID de l'utilisateur BOOTCAMP qui envoie l'invitation
  candidateId      String                      // ID du candidat invité
  status           BootcampInvitationStatus     @default(PENDING)
  message          String?                     // Message personnalisé
  createdAt        DateTime                    @default(now())
  updatedAt        DateTime                    @updatedAt
  respondedAt      DateTime?                   // Date de réponse (acceptation/refus)
  
  // Relations
  bootcamp         User                        @relation("BootcampInvitationSender", fields: [bootcampId], references: [id], onDelete: Cascade)
  candidate        User                        @relation("BootcampInvitationReceiver", fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([bootcampId, candidateId])
  @@index([bootcampId])
  @@index([candidateId])
  @@index([status])
  @@index([createdAt])
  @@map("bootcamp_invitations")
}